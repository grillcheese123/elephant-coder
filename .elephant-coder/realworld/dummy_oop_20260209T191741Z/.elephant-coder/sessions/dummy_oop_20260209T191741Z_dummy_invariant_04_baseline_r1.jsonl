{"ts": "2026-02-09T19:19:00Z", "session_id": "dummy_oop_20260209T191741Z_dummy_invariant_04_baseline_r1", "role": "user", "command": "/code", "run_id": "run_eb9470db3802", "content": "Create docs/quality/invariants.md describing extension contracts and architectural invariants (registry contract, processor inheritance rules, and repository contract). Keep runtime behavior unchanged."}
{"ts": "2026-02-09T19:19:00Z", "session_id": "dummy_oop_20260209T191741Z_dummy_invariant_04_baseline_r1", "role": "assistant", "command": "/code", "run_id": "run_eb9470db3802", "content": "```json\n{\n  \"summary\": \"Created docs/quality/invariants.md documenting extension contracts and architectural invariants for the workflow engine: registry contract (build_default_runtime), processor inheritance rules (BaseProcessor subclassing and channel binding), and repository contract (WorkItemRepository interface). Runtime behavior unchanged.\",\n  \"project\": {\n    \"language\": \"python\"\n  },\n  \"files\": [\n    {\n      \"path\": \"docs/quality/invariants.md\",\n      \"content\": \"# Architectural Invariants\\n\\nThis document describes the extension contracts and architectural invariants that must be preserved when extending the workflow engine.\\n\\n## Registry Contract\\n\\nThe `build_default_runtime()` function in `workflow_engine/runtime/registry.py` defines the system's default composition. It returns a `Runtime` instance containing:\\n\\n- A `DispatcherService` instance\\n- A `WorkItemRepository` instance (e.g., `InMemoryWorkItemRepository`)\\n- A set of default processors\\n\\n### Invariants\\n\\n- **Deterministic composition**: `build_default_runtime()` must always return a consistent runtime configuration.\\n- **Processor registration**: All default processors must be registered with the dispatcher before returning.\\n- **Repository reuse**: The same repository instance must be passed to both the dispatcher and returned for external access.\\n\\n## Processor Inheritance Rules\\n\\nProcessors must follow a strict inheritance hierarchy to ensure correct dispatch behavior.\\n\\n### Contract\\n\\n1. **Abstract base contract** (`Processor`)\\n   - Defines required interface: `name`, `supports()`, `process()`\\n   - All processors must implement this contract\\n\\n2. **Base implementation** (`BaseProcessor`)\\n   - Implements `supports()` using a class-level `supported_channel` attribute\\n   - Implements `process()` with channel validation and `_deliver()` delegation\\n   - Subclasses must set `supported_channel` and implement `_deliver()`\\n\\n3. **Concrete processors**\\n   - Extend `BaseProcessor`\\n   - Set `supported_channel` to a unique channel name\\n   - Implement `_deliver()` with channel-specific logic\\n\\n### Invariants\\n\\n- **Channel uniqueness**: Each processor's `supported_channel` must be distinct.\\n- **Inheritance chain**: All processors must inherit from `BaseProcessor` (directly or indirectly).\\n- **No override of supports/process**: Concrete processors must not override `supports()` or `process()`\u2014only `_deliver()`.\\n\\n## Repository Contract\\n\\nThe `WorkItemRepository` interface defines the persistence boundary.\\n\\n### Contract\\n\\n- `save(item)`: Persist a work item\\n- `get(identifier)`: Retrieve by ID\\n- `list_by_channel(channel)`: Filter items by channel\\n- `list_all()`: Retrieve all items\\n\\n### Invariants\\n\\n- **Consistent identity**: `item.identifier` must be stable across save/get cycles\\n- **Channel filtering**: `list_by_channel()` must return only items matching the channel\\n- **Non-destructive**: Repository operations must not mutate input items\\n\\n## Extension Guidelines\\n\\n### Adding a New Processor\\n\\n1. Create subclass of `BaseProcessor`\\n2. Set `supported_channel = \\\"new-channel\\\"`\\n3. Implement `_deliver(item)`\\n4. Register in `build_default_runtime()` if needed\\n\\n### Adding a New Repository\\n\\n1. Implement `WorkItemRepository` interface\\n2. Ensure thread-safety if required\\n3. Preserve invariants: identifier stability, channel filtering, non-destructive operations\\n\\n### Adding a New Work Item Type\\n\\n1. Implement `WorkItem` contract\\n2. Ensure `identifier`, `channel`, and `payload` are stable\\n3. Update repository to handle new type if needed\\n\"\n    }\n  ],\n  \"dependencies\": {\n    \"dependencies\": {},\n    \"devDependencies\": {},\n    \"python\": [],\n    \"pythonDev\": [],\n    \"rust\": [],\n    \"go\": [],\n    \"cpp\": []\n  },\n  \"commands\": []\n}\n```"}
