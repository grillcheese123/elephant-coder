{"ts": "2026-02-09T19:53:25Z", "session_id": "dummy_policy_engine_20260209T194851Z_policy_invariant_04_elephant_r1", "role": "user", "command": "/code", "run_id": "run_49bee5226d45", "content": "Create docs/quality/invariants.md describing extension contracts and architectural invariants (registry contract, processor inheritance rules, and repository contract). Keep runtime behavior unchanged."}
{"ts": "2026-02-09T19:53:25Z", "session_id": "dummy_policy_engine_20260209T194851Z_policy_invariant_04_elephant_r1", "role": "assistant", "command": "/code", "run_id": "run_49bee5226d45", "content": "```json\n{\n  \"summary\": \"Created docs/quality/invariants.md documenting extension contracts and architectural invariants for registry, processor, and repository contracts.\",\n  \"project\": {\n    \"language\": \"python\"\n  },\n  \"files\": [\n    {\n      \"path\": \"docs/quality/invariants.md\",\n      \"content\": \"# Architectural Invariants\\n\\nThis document describes the extension contracts and architectural invariants that must be preserved when extending the Policy Engine.\\n\\n## Overview\\n\\nThe Policy Engine enforces strict architectural boundaries through abstract contracts. All extensions must adhere to these contracts to ensure correct dispatching, processing, and persistence behavior.\\n\\n## Extension Contracts\\n\\n### 1. Processor Contract (`src/policy_engine/contracts/processor.py`)\\n\\nAll channel-specific processors must implement the `Processor` abstract base class:\\n\\n- **`name: str`** (property): Human-readable identifier for the processor.\\n- **`supports(item: WorkItem) -> bool`**: Determines whether this processor can handle a given work item.\\n- **`process(item: WorkItem) -> RunResult`**: Executes processing logic and returns a structured result.\\n\\n#### Inheritance Rules\\n\\n- Processors must be registered in the runtime registry to be dispatchable.\\n- `supports()` must be deterministic and consistent for a given item.\\n- `process()` must not mutate the input `WorkItem`.\\n- All exceptions during processing must be caught and reflected in `RunResult.success` and `details`.\\n\\n### 2. Repository Contract (`src/policy_engine/contracts/repository.py`)\\n\\nAll persistence layers must implement the `WorkItemRepository` abstract base class:\\n\\n- **`save(item: WorkItem) -> None`**: Persist a work item.\\n- **`get(identifier: str) -> WorkItem | None`**: Retrieve a work item by ID.\\n- **`list_by_channel(channel: str) -> list[WorkItem]`**: List items targeting a specific channel.\\n- **`list_all() -> list[WorkItem]`**: List all stored items.\\n\\n#### Invariants\\n\\n- `save()` must be idempotent for the same item.\\n- `get()` must return `None` if the item does not exist.\\n- `list_by_channel()` and `list_all()` must return fresh copies or immutable views to prevent external mutation.\\n\\n### 3. Registry Contract (Implicit)\\n\\nThe runtime maintains an internal registry mapping channel names to processor instances. While not explicitly defined as a contract class, the registry enforces:\\n\\n- Each channel maps to exactly one processor.\\n- Processors must be registered before dispatching items for that channel.\\n- Attempting to dispatch to an unregistered channel raises `LookupError`.\\n\\n## Work Item Contract (`src/policy_engine/contracts/work_item.py`)\\n\\nAll work items must implement:\\n\\n- **`identifier: str`**: Stable, unique ID for traceability.\\n- **`channel: str`**: Target delivery channel (e.g., `email`, `push`).\\n- **`payload: dict[str, str]`**: Message payload.\\n\\n## Runtime Behavior Preservation\\n\\nAll invariants above must be maintained to ensure:\\n\\n- `runtime.dispatch(ticket)` behaves deterministically.\\n- Dispatching to unsupported channels raises `LookupError`.\\n- Processing results are correctly captured in `RunResult` objects.\\n- Persistence operations do not corrupt or lose work items.\\n\\n## Summary\\n\\nExtensions must:\\n\\n1. Implement `Processor`, `WorkItemRepository`, and `WorkItem` contracts exactly.\\n2. Register processors in the runtime registry before dispatch.\\n3. Preserve immutability and idempotency in processing and persistence.\\n4. Handle errors gracefully via `RunResult` instead of propagating exceptions.\\n\\nViolating these invariants may cause runtime failures or inconsistent state.\"\n    }\n  ],\n  \"dependencies\": {\n    \"dependencies\": {},\n    \"devDependencies\": {},\n    \"python\": [],\n    \"pythonDev\": [],\n    \"rust\": [],\n    \"go\": [],\n    \"cpp\": []\n  },\n  \"commands\": []\n}\n```"}
