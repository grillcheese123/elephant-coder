{"ts": "2026-02-09T19:53:04Z", "session_id": "dummy_policy_engine_20260209T194851Z_policy_invariant_04_baseline_r1", "role": "user", "command": "/code", "run_id": "run_d2e8fca43345", "content": "Create docs/quality/invariants.md describing extension contracts and architectural invariants (registry contract, processor inheritance rules, and repository contract). Keep runtime behavior unchanged."}
{"ts": "2026-02-09T19:53:04Z", "session_id": "dummy_policy_engine_20260209T194851Z_policy_invariant_04_baseline_r1", "role": "assistant", "command": "/code", "run_id": "run_d2e8fca43345", "content": "{\"summary\": \"Create docs/quality/invariants.md documenting extension contracts and architectural invariants for registry, processor inheritance, and repository contracts.\", \"project\": {\"language\": \"python\"}, \"files\": [{\"path\": \"docs/quality/invariants.md\", \"content\": \"# Architectural Invariants\\n\\nThis document specifies extension contracts and architectural invariants that must be preserved to maintain system correctness and extensibility.\\n\\n---\\n\\n## Registry Contract\\n\\nThe system uses a registry to manage channel-specific processors. The registry must:\\n\\n- Support registration of processors by channel name.\\n- Enable lookup of processors by channel.\\n- Raise `LookupError` when no processor supports a requested channel.\\n\\n### Extension Rules\\n\\n- New processors must be registered in the runtime\u2019s processor registry.\\n- Registration key must match the `supported_channel` of the processor.\\n- Duplicate registrations are disallowed.\\n\\n---\\n\\n## Processor Inheritance Rules\\n\\nAll channel-specific processors must inherit from `BaseProcessor` and adhere to the following:\\n\\n1. **`supported_channel` class attribute**\\n   - Must be a non-empty string.\\n   - Must match the `channel` property of incoming `WorkItem`s.\\n\\n2. **`_deliver(item: WorkItem) -> str` method**\\n   - Must be implemented by subclasses.\\n   - Encapsulates channel-specific side effects.\\n   - Returns a human-readable success message.\\n\\n3. **Behavioral guarantees**\\n   - `supports(item)` returns `True` only if `item.channel == self.supported_channel`.\\n   - `process(item)` returns a `RunResult` with `success=True` only when `_deliver` succeeds.\\n   - `process(item)` returns `success=False` with descriptive `details` if the channel is unsupported.\\n\\n### Extension Rules\\n\\n- Do **not** override `supports` or `process` in subclasses.\\n- Do **not** mutate `item.payload` or `item.identifier` during processing.\\n- Subclasses must not change the `RunResult` structure.\\n\\n---\\n\\n## Repository Contract\\n\\nThe `WorkItemRepository` abstract contract defines persistence boundaries. Implementations must:\\n\\n- Preserve `WorkItem.identifier` immutability.\\n- Support `save`, `get`, `list_by_channel`, and `list_all` operations.\\n- Return `None` from `get(identifier)` when no item exists.\\n- Return empty lists from list operations when no items match.\\n\\n### Extension Rules\\n\\n- Repository implementations must not alter `WorkItem` identity or channel.\\n- Persistence must be transactional: `save` must be atomic.\\n- `list_by_channel` must filter strictly on `item.channel`.\\n\\n---\\n\\n## Invariant Summary\\n\\n| Component | Invariant | Consequence of Violation |\\n|----------|-----------|--------------------------|\\n| Registry | One processor per channel | Ambiguous dispatch, runtime errors |\\n| Processor | Inherit `BaseProcessor`, set `supported_channel`, implement `_deliver` | Incorrect dispatch or unhandled channels |\\n| Repository | Immutable identifiers, full CRUD support | Data loss or traceability failure |\\n\\n---\\n\\n## References\\n\\n- `src/policy_engine/contracts/processor.py`\\n- `src/policy_engine/contracts/repository.py`\\n- `src/policy_engine/contracts/work_item.py`\\n- `src/policy_engine/processors/base_processor.py`\"}], \"dependencies\": {\"dependencies\": {}, \"devDependencies\": {}, \"python\": [], \"pythonDev\": [], \"rust\": [], \"go\": [], \"cpp\": []}, \"commands\": []}"}
