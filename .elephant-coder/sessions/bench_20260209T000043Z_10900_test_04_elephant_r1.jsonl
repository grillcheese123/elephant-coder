{"ts": "2026-02-09T00:10:43Z", "session_id": "bench_20260209T000043Z_10900_test_04_elephant_r1", "role": "user", "command": "/code", "run_id": "run_6068d4f44dbd", "content": "Write tests for baseline mode markers and context manifest fields."}
{"ts": "2026-02-09T00:10:43Z", "session_id": "bench_20260209T000043Z_10900_test_04_elephant_r1", "role": "assistant", "command": "/code", "run_id": "run_6068d4f44dbd", "content": "{\"summary\": \"Write unit tests for baseline mode markers and context manifest fields in the test suite. The baseline mode and context manifest are core to the CLI's response envelope and plan command behavior. Tests should cover default baseline mode, explicit baseline mode toggling, and validation of context manifest fields included in the output envelope.\", \"project\": {\"language\": \"python\"}, \"files\": [{\"path\": \"tests/test_context_manifest.py\", \"content\": \"\\\"\\\"\\\"Tests for baseline mode markers and context manifest fields.\\\"\\\"\\\"\\n\\nfrom __future__ import annotations\\n\\nimport json\\nimport sys\\nfrom pathlib import Path\\n\\nimport importlib.util\\n\\n\\ndef _load_cli_module():\\n    root = Path(__file__).resolve().parents[1]\\n    cli_path = root / \\\"scripts\\\" / \\\"elephant_cli.py\\\"\\n    spec = importlib.util.spec_from_file_location(\\\"elephant_cli_local\\\", cli_path)\\n    if spec is None or spec.loader is None:\\n        raise RuntimeError(\\\"Unable to load scripts/elephant_cli.py\\\")\\n    module = importlib.util.module_from_spec(spec)\\n    sys.modules[spec.name] = module\\n    spec.loader.exec_module(module)\\n    return module\\n\\n\\nelephant_cli = _load_cli_module()\\n\\n\\ndef _parse(argv: list[str]):\\n    parser = elephant_cli._build_parser()\\n    return elephant_cli._parse(parser, argv)\\n\\n\\ndef test_baseline_mode_default_is_true(tmp_path: Path, monkeypatch):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\"])\\n    assert args.baseline is True\\n\\n\\ndef test_baseline_mode_can_be_disabled(tmp_path: Path, monkeypatch):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\", \\\"--no-baseline\\\"])\\n    assert args.baseline is False\\n\\n\\ndef test_baseline_mode_can_be_explicitly_enabled(tmp_path: Path, monkeypatch):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\", \\\"--baseline\\\"])\\n    assert args.baseline is True\\n\\n\\ndef test_context_manifest_in_plan_output(tmp_path: Path, monkeypatch, capsys):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\", \\\"--output\\\", \\\"json\\\"])\\n    envelope = elephant_cli._build_plan_envelope(args, \\\"test prompt\\\", \\\"test response\\\", {}, {})\\n    assert \\\"context_manifest\\\" in envelope\\n    manifest = envelope[\\\"context_manifest\\\"]\\n    assert \\\"baseline_mode\\\" in manifest\\n    assert manifest[\\\"baseline_mode\\\"] is True\\n    assert \\\"task_fingerprint\\\" in manifest\\n    assert \\\"bundle_fingerprint\\\" in manifest\\n    assert \\\"top_modalities\\\" in manifest\\n    assert \\\"bundle_similarity_to_task\\\" in manifest\\n\\n\\ndef test_context_manifest_baseline_false(tmp_path: Path, monkeypatch, capsys):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\", \\\"--output\\\", \\\"json\\\", \\\"--no-baseline\\\"])\\n    envelope = elephant_cli._build_plan_envelope(args, \\\"test prompt\\\", \\\"test response\\\", {}, {})\\n    manifest = envelope[\\\"context_manifest\\\"]\\n    assert manifest[\\\"baseline_mode\\\"] is False\\n\\n\\ndef test_context_manifest_fields_are_serializable(tmp_path: Path, monkeypatch, capsys):\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    args = _parse([\\\"plan\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add feature\\\", \\\"--output\\\", \\\"json\\\"])\\n    envelope = elephant_cli._build_plan_envelope(args, \\\"test prompt\\\", \\\"test response\\\", {}, {})\\n    # Ensure the envelope is JSON-serializable\\n    json_str = json.dumps(envelope)\\n    parsed = json.loads(json_str)\\n    assert \\\"context_manifest\\\" in parsed\\n    manifest = parsed[\\\"context_manifest\\\"]\\n    assert isinstance(manifest[\\\"baseline_mode\\\"], bool)\\n    assert isinstance(manifest[\\\"task_fingerprint\\\"], str)\\n    assert isinstance(manifest[\\\"bundle_fingerprint\\\"], str)\\n    assert isinstance(manifest[\\\"top_modalities\\\"], dict)\\n    assert isinstance(manifest[\\\"bundle_similarity_to_task\\\"], float)\\n\"}], \"dependencies\": {\"dependencies\": {}, \"devDependencies\": {}, \"python\": [], \"pythonDev\": [\"pytest>=8.0.0\"]}, \"commands\": [\"pytest tests/test_context_manifest.py -v\"]}"}
