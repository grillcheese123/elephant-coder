{"ts": "2026-02-09T00:19:34Z", "session_id": "full_strategy_20260209a_bugfix_04_elephant_r1", "role": "user", "command": "/code", "run_id": "run_871b74824f48", "content": "Fix OpenRouter retry logic so fatal auth errors do not retry and transient errors do."}
{"ts": "2026-02-09T00:19:34Z", "session_id": "full_strategy_20260209a_bugfix_04_elephant_r1", "role": "assistant", "command": "/code", "run_id": "run_871b74824f48", "content": "{\"summary\": \"The OpenRouter client's retry logic needs to be updated to distinguish between fatal authentication errors (e.g., 401/403) and transient errors (e.g., 429/5xx), so that only transient errors are retried. Based on the AST and runtime traces, the core logic resides in elephant_coder/openrouter_client.py, specifically in the OpenRouterClient class and its chat_completion method. The fix involves adding error classification logic to check HTTP status codes or error types before deciding to retry.\", \"project\": {\"language\": \"python\"}, \"files\": [{\"path\": \"elephant_coder/openrouter_client.py\", \"content\": \"\\\"\\\"\\\"OpenRouter API client with retry logic.\\\"\\\"\\\"\\n\\nfrom __future__ import annotations\\n\\nimport time\\nfrom typing import Any\\n\\n\\nclass OpenRouterResult:\\n    \\\"\\\"\\\"Result of an OpenRouter API call.\\\"\\\"\\\"\\n\\n    def __init__(self, content: str, model: str):\\n        self.content = content\\n        self.model = model\\n\\n\\nclass OpenRouterError(RuntimeError):\\n    \\\"\\\"\\\"Base error for OpenRouter API issues.\\\"\\\"\\\"\\n\\n    def __init__(self, message: str, status_code: int | None = None):\\n        super().__init__(message)\\n        self.status_code = status_code\\n\\n\\nclass OpenRouterClient:\\n    \\\"\\\"\\\"Client for OpenRouter API with intelligent retry logic.\\\"\\\"\\\"\\n\\n    def __init__(self, api_key: str):\\n        self.api_key = api_key\\n        self._max_retries = 3\\n        self._retry_delay = 1.0\\n\\n    def _is_transient_error(self, error: OpenRouterError) -> bool:\\n        \\\"\\\"\\\"Determine if an error is transient (retryable) or fatal.\\\"\\\"\\\"\\n        if error.status_code is None:\\n            return True  # Network errors are transient\\n        # Fatal auth errors: 401 Unauthorized, 403 Forbidden\\n        if error.status_code in (401, 403):\\n            return False\\n        # Transient errors: 429 Too Many Requests, 5xx Server Errors\\n        if error.status_code in (429, 500, 502, 503, 504):\\n            return True\\n        # Other errors are considered fatal by default\\n        return False\\n\\n    def chat_completion(self) -> OpenRouterResult:\\n        \\\"\\\"\\\"Call OpenRouter chat completion with retry logic.\\\"\\\"\\\"\\n        import urllib.request\\n        import urllib.error\\n        import json\\n\\n        url = \\\"https://openrouter.ai/api/v1/chat/completions\\\"\\n        headers = {\\n            \\\"Authorization\\\": f\\\"Bearer {self.api_key}\\\",\\n            \\\"Content-Type\\\": \\\"application/json\\\",\\n        }\\n        payload = json.dumps({\\\"model\\\": \\\"openai/gpt-4\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": \\\"Hello\\\"}]}).encode()\\n\\n        retries = 0\\n        while True:\\n            try:\\n                req = urllib.request.Request(url, data=payload, headers=headers, method=\\\"POST\\\")\\n                with urllib.request.urlopen(req, timeout=30) as response:\\n                    result = json.loads(response.read().decode())\\n                    content = result[\\\"choices\\\"][0][\\\"message\\\"][\\\"content\\\"]\\n                    model = result[\\\"model\\\"]\\n                    return OpenRouterResult(content=content, model=model)\\n            except urllib.error.HTTPError as e:\\n                error = OpenRouterError(str(e), status_code=e.code)\\n                if not self._is_transient_error(error) or retries >= self._max_retries:\\n                    raise error\\n                retries += 1\\n                time.sleep(self._retry_delay * (2 ** (retries - 1)))  # Exponential backoff\\n            except Exception as e:\\n                error = OpenRouterError(str(e))\\n                if not self._is_transient_error(error) or retries >= self._max_retries:\\n                    raise error\\n                retries += 1\\n                time.sleep(self._retry_delay * (2 ** (retries - 1)))\\n\"}], \"dependencies\": {\"dependencies\": {}, \"devDependencies\": {}}, \"commands\": [\"pip install -e .\", \"pytest tests/test_benchmark_runner.py -v\"]}"}
