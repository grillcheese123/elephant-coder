{"ts": "2026-02-09T00:40:08Z", "session_id": "full_prompt_parity_20260209a_test_02_elephant_r1", "role": "user", "command": "/code", "run_id": "run_2d04764925db", "content": "Write tests for model retry and fallback telemetry in /code responses."}
{"ts": "2026-02-09T00:40:08Z", "session_id": "full_prompt_parity_20260209a_test_02_elephant_r1", "role": "assistant", "command": "/code", "run_id": "run_2d04764925db", "content": "{\"summary\": \"Write tests for model retry and fallback telemetry in /code responses.\", \"project\": {\"language\": \"python\"}, \"files\": [{\"path\": \"tests/test_model_retry_fallback.py\", \"content\": \"\\\"\\\"\\\"Tests for model retry and fallback telemetry in /code responses.\\\"\\\"\\\"\\n\\nfrom __future__ import annotations\\n\\nimport importlib.util\\nimport sys\\nfrom pathlib import Path\\n\\n\\ndef _load_cli_module():\\n    root = Path(__file__).resolve().parents[1]\\n    cli_path = root / \\\"scripts\\\" / \\\"elephant_cli.py\\\"\\n    spec = importlib.util.spec_from_file_location(\\\"elephant_cli_local\\\", cli_path)\\n    if spec is None or spec.loader is None:\\n        raise RuntimeError(\\\"Unable to load scripts/elephant_cli.py\\\")\\n    module = importlib.util.module_from_spec(spec)\\n    sys.modules[spec.name] = module\\n    spec.loader.exec_module(module)\\n    return module\\n\\n\\nelephant_cli = _load_cli_module()\\n\\n\\ndef test_code_command_retries_on_retryable_error(tmp_path: Path, monkeypatch):\\n    \\\"\\\"\\\"Verify /code retries on retryable model errors and records telemetry.\\\"\\\"\\\"\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    # Force a known retryable error by mocking the OpenRouter client\\n    original_client = elephant_cli._new_openrouter_client\\n    call_count = [0]\\n    def mock_client(api_key: str):\\n        client = original_client(api_key)\\n        original_chat = client.chat_completion\\n        def failing_chat(*args, **kwargs):\\n            call_count[0] += 1\\n            if call_count[0] < 3:\\n                raise elephant_cli.OpenRouterError(\\\"HTTP 429: Rate limit exceeded\\\")\\n            return original_chat(*args, **kwargs)\\n        client.chat_completion = failing_chat\\n        return client\\n    monkeypatch.setattr(elephant_cli, \\\"_new_openrouter_client\\\", mock_client)\\n    args = elephant_cli._parse([\\\"code\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add one\\\", \\\"--output\\\", \\\"json\\\"])\\n    code, response = elephant_cli.execute_command(args)\\n    assert code == 0\\n    assert response[\\\"ok\\\"] is True\\n    assert call_count[0] == 3\\n    metrics = response.get(\\\"metrics\\\", {})\\n    assert metrics.get(\\\"model_retries\\\", 0) == 2\\n\\n\\ndef test_code_command_falls_back_to_secondary_model(tmp_path: Path, monkeypatch):\\n    \\\"\\\"\\\"Verify /code falls back to secondary model on fatal errors and records telemetry.\\\"\\\"\\\"\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    original_client = elephant_cli._new_openrouter_client\\n    call_count = [0]\\n    def mock_client(api_key: str):\\n        client = original_client(api_key)\\n        original_chat = client.chat_completion\\n        def fallback_chat(*args, **kwargs):\\n            call_count[0] += 1\\n            if call_count[0] == 1:\\n                raise elephant_cli.OpenRouterError(\\\"HTTP 404: Model not found\\\")\\n            return original_chat(*args, **kwargs)\\n        client.chat_completion = fallback_chat\\n        return client\\n    monkeypatch.setattr(elephant_cli, \\\"_new_openrouter_client\\\", mock_client)\\n    args = elephant_cli._parse([\\\"code\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add one\\\", \\\"--output\\\", \\\"json\\\"])\\n    code, response = elephant_cli.execute_command(args)\\n    assert code == 0\\n    assert response[\\\"ok\\\"] is True\\n    assert call_count[0] == 2\\n    metrics = response.get(\\\"metrics\\\", {})\\n    assert metrics.get(\\\"model_fallbacks\\\", 0) == 1\\n\\n\\ndef test_code_command_records_model_error_telemetry(tmp_path: Path, monkeypatch):\\n    \\\"\\\"\\\"Verify /code records model error types and counts.\\\"\\\"\\\"\\n    (tmp_path / \\\"pyproject.toml\\\").write_text(\\\"[project]\\\\nname='tmp'\\\\n\\\", encoding=\\\"utf-8\\\")\\n    monkeypatch.setenv(\\\"ELEPHANT_PROJECT_ROOT\\\", str(tmp_path))\\n    original_client = elephant_cli._new_openrouter_client\\n    call_count = [0]\\n    def mock_client(api_key: str):\\n        client = original_client(api_key)\\n        original_chat = client.chat_completion\\n        def failing_chat(*args, **kwargs):\\n            call_count[0] += 1\\n            raise elephant_cli.OpenRouterError(\\\"HTTP 429: Rate limit exceeded\\\")\\n        client.chat_completion = failing_chat\\n        return client\\n    monkeypatch.setattr(elephant_cli, \\\"_new_openrouter_client\\\", mock_client)\\n    args = elephant_cli._parse([\\\"code\\\", \\\"--cwd\\\", str(tmp_path), \\\"--task\\\", \\\"add one\\\", \\\"--output\\\", \\\"json\\\"])\\n    code, response = elephant_cli.execute_command(args)\\n    assert code == 1\\n    assert response[\\\"ok\\\"] is False\\n    assert response[\\\"error_code\\\"] == \\\"E_MODEL\\\"\\n    metrics = response.get(\\\"metrics\\\", {})\\n    assert \\\"model_errors\\\" in metrics\\n    assert metrics[\\\"model_errors\\\"].get(\\\"HTTP 429\\\", 0) >= 1\\n\\n\\ndef test_is_retryable_model_error_recognizes_known_patterns():\\n    \\\"\\\"\\\"Verify retryable error detection for known patterns.\\\"\\\"\\\"\\n    assert elephant_cli._is_retryable_model_error(\\\"HTTP 429\\\") is True\\n    assert elephant_cli._is_retryable_model_error(\\\"Rate limit exceeded\\\") is True\\n    assert elephant_cli._is_retryable_model_error(\\\"Connection reset\\\") is True\\n    assert elephant_cli._is_retryable_model_error(\\\"Network error\\\") is True\\n    assert elephant_cli._is_retryable_model_error(\\\"HTTP 404\\\") is False\\n    assert elephant_cli._is_retryable_model_error(\\\"Invalid API key\\\") is False\\n\\n\\ndef test_is_fatal_model_error_recognizes_known_patterns():\\n    \\\"\\\"\\\"Verify fatal error detection for known patterns.\\\"\\\"\\\"\\n    assert elephant_cli._is_fatal_model_error(\\\"HTTP 404\\\") is True\\n    assert elephant_cli._is_fatal_model_error(\\\"Invalid API key\\\") is True\\n    assert elephant_cli._is_fatal_model_error(\\\"HTTP 401\\\") is True\\n    assert elephant_cli._is_fatal_model_error(\\\"HTTP 429\\\") is False\\n    assert elephant_cli._is_fatal_model_error(\\\"Rate limit exceeded\\\") is False\\n\"}], \"dependencies\": {\"dependencies\": {}, \"devDependencies\": {}, \"python\": [], \"pythonDev\": [], \"rust\": [], \"go\": [], \"cpp\": []}, \"commands\": [\"pytest tests/test_model_retry_fallback.py -v\"]}"}
